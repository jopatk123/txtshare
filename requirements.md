# 文本分享链接网页项目需求文档
## 1. 项目概述
本项目旨在开发一个**无用户登录**的轻量级文本分享网页工具，用户可通过网页粘贴文本生成唯一公开分享链接，访客打开链接即可查看对应文本；支持文本永不过期默认配置，同时允许用户自定义设置过期时间。项目采用**Docker单容器部署**策略，通过宿主机Nginx反向代理并配置SSL证书，满足小流量场景下的文本分享需求，兼顾安全性与性能优化。

## 2. 核心需求
### 2.1 功能需求
| 模块 | 具体需求 |
|------|----------|
| **前端页面** | 1. 提供简洁文本输入框，支持多行文本粘贴；<br>2. 配置"生成分享链接"按钮，点击后触发后端接口请求；<br>3. 支持自定义过期时间设置项（默认永不过期，可选"1小时/1天/7天/30天/自定义天数"）；<br>4. 链接生成后，前端展示可复制的分享链接（格式：`https://script.jopatk.top/s/{唯一ID}`）；<br>5. 访客打开链接页面，自动渲染展示对应的文本内容；<br>6. 适配PC端与移动端，保证跨设备访问体验一致；<br>7. 添加复制链接按钮，提供便捷的复制功能；<br>8. 新增链接失效/404专属页面，展示友好提示。 |
| **后端接口（Node.js）** | 1. 开发 POST `/api/create` 接口：接收前端传入的文本内容与过期时间参数，生成8位以上随机唯一ID，将ID、文本、创建时间、过期时间存入数据库，返回生成的分享链接；<br>2. 开发 GET `/api/text/:id` 接口：接收分享链接中的唯一ID，查询数据库中对应文本，若文本未过期则返回内容，若已过期则返回"链接已失效"提示；<br>3. 开发 GET `/s/:id` 接口：用于直接访问分享页面，渲染HTML页面；<br>4. 支持过期时间逻辑：默认永不过期（数据库过期时间字段设为NULL），自定义时间则计算并存储到期时间戳；<br>5. 项目入口拆分：新增`index.js`作为服务启动入口，`app.js`专注于Express应用配置。 |
| **数据存储** | 1. 采用SQLite数据库，设计`share_text`表，字段如下：<br>   - id：VARCHAR(16) 主键（唯一分享ID）<br>   - content：TEXT（存储分享文本）<br>   - create_time：TIMESTAMP DEFAULT CURRENT_TIMESTAMP（创建时间）<br>   - expire_time：TIMESTAMP（过期时间，NULL表示永不过期）<br>   - view_count：INTEGER DEFAULT 0（访问次数，用于扩展统计功能）<br>2. 数据库文件统一存放于`src/server/db`目录，配套建表脚本`init.sql`；<br>3. 支持定时清理过期数据，避免数据库冗余；<br>4. 为`id`字段（主键）和`expire_time`字段添加索引，提升查询效率。 |

### 2.2 非功能需求
#### 2.2.1 安全限制
1. **文本长度限制**：后端强制限制单条文本最大长度为100KB（约10万字），超出则返回"文本过长，请删减后重试"的错误提示。
2. **XSS防护**：后端对存储的文本内容进行HTML转义处理（如将`<`转义为`&lt;`、`>`转义为`&gt;`），前端渲染时直接展示转义后的内容，防止跨站脚本攻击。
3. **防链接遍历攻击**：唯一ID采用随机字符串生成（如结合`crypto`模块生成字母数字混合的8-16位字符串），禁止使用自增ID，降低ID被猜中的概率。
4. **请求限流**：对后端接口配置基础限流策略（如单IP每分钟最多请求30次），防止恶意刷接口占用服务器资源。
5. **SQL注入防护**：使用参数化查询或ORM框架，防止SQL注入攻击。

#### 2.2.2 性能优化
1. **内存缓存**：使用`node-cache`对频繁访问的未过期文本进行缓存，减轻数据库压力，缓存时间根据过期时间动态设置。
2. **定时清理任务**：使用`node-schedule`每天凌晨执行一次过期数据清理任务，删除已过期的记录并同步清理缓存。
3. **日志记录**：新增日志目录`src/server/logs`，记录应用运行日志、错误日志、定时任务日志，便于问题排查。

#### 2.2.3 兼容性需求
1. 前端页面兼容主流浏览器（Chrome、Firefox、Safari、Edge）。
2. 后端接口支持跨域请求，保证前端与后端正常通信。
3. 适配不同屏幕尺寸，保证移动端与PC端访问体验一致。

#### 2.2.4 部署需求
1. **Docker部署策略**：
   - 采用单容器一体化部署，包含Node.js应用和所有依赖
   - 数据库文件通过Docker持久化卷挂载，防止数据丢失
   - 容器运行在6006端口
   - 使用Docker管理工具（如docker-compose）进行容器管理
   - 日志目录可选持久化挂载，方便宿主机查看日志
   - `.dockerignore`配置忽略`node_modules`、日志、编辑器配置等无用文件，减小镜像体积
2. **Nginx配置**：
   - 宿主机直接运行Nginx（非容器化）
   - 配置反向代理，将`script.jopatk.top`域名流量代理到Docker容器的6006端口
   - 配置SSL证书（采用Let's Encrypt免费证书，支持自动续期）
3. **域名解析**：将`script.jopatk.top`域名解析到服务器IP地址`43.163.120.212`。

## 3. 技术栈选型
| 分类 | 技术选型 | 选型理由 |
|------|----------|----------|
| 前端 | HTML5 + CSS3 + JavaScript（原生） | 无需框架，降低开发成本，满足轻量需求 |
| 后端 | Node.js + Express | 轻量高效，适合快速开发RESTful接口 |
| 数据库 | SQLite | 无需独立部署，文件型数据库，适配小流量场景 |
| 缓存 | node-cache | 轻量级Node.js内存缓存库，配置简单 |
| 定时任务 | node-schedule | 纯Node.js实现，无需依赖系统定时任务 |
| 部署环境 | Docker + Docker Compose | 实现环境标准化，简化部署流程 |
| Web服务器 | Nginx（宿主机直接运行） | 反向代理、SSL证书管理、静态资源服务 |
| SSL证书 | Let's Encrypt + Certbot | 免费SSL证书，支持自动续期 |
| 日志工具 | winston（可选） | 轻量级Node.js日志库，支持多级别日志记录 |

## 4. 项目结构
```
text-share/
├── Dockerfile                    # Docker构建文件
├── docker-compose.yml           # Docker Compose配置
├── .dockerignore                # Docker忽略文件
├── package.json                # Node.js依赖配置
├── README.md                   # 项目说明文档
└── src/
    ├── server/                  # 后端代码
    │   ├── index.js             # 项目唯一入口文件（启动服务、监听端口）
    │   ├── app.js              # Express应用主配置文件（中间件、路由、跨域）
    │   ├── routes/             # 路由定义
    │   ├── controllers/        # 控制器
    │   ├── models/             # 数据模型
    │   ├── middleware/         # 中间件（限流、日志等）
    │   ├── utils/              # 工具函数
    │   │   ├── idGenerator.js  # 生成唯一ID工具
    │   │   ├── xssFilter.js    # XSS转义处理工具
    │   │   ├── dateUtil.js     # 过期时间计算工具
    │   │   └── validator.js    # 文本校验/参数校验工具
    │   ├── db/                 # 数据库目录
    │   │   ├── init.sql        # 数据库初始化建表脚本
   │   │   └── data/share_text.db   # SQLite核心数据库文件（持久化目录）
    │   └── logs/               # 应用日志目录
    └── public/                  # 前端静态资源
        ├── index.html          # 主页面-生成分享链接
        ├── share.html          # 分享页面-查看文本
        ├── expired.html        # 链接失效/404专属页面
        ├── css/                # 样式文件
        ├── js/                 # 前端脚本
        └── assets/             # 静态资源（图片/图标）
```

## 5. 扩展需求（可选）
1. **文本格式预览**：如代码文本高亮、Markdown格式渲染（前端静态资源存放于`public/js/`和`public/css/`）。
2. **监控与日志**：集成应用监控和日志收集，便于问题排查。

